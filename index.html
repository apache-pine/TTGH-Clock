<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lunch / Home Countdown</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="clock.png" type="image/svg+xml">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .wrapper {
            text-align: center;
        }

        #countdown {
            font-size: 3rem;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .note {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .controls {
            margin-top: 1rem;
        }

        .controls button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background: #111827;
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .controls button:hover {
            background: #1f2937;
        }

        /* Bottom-left corner controls */
        .corner-controls {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .corner-controls button {
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background: #020617;
            color: #9ca3af;
            cursor: pointer;
        }

        .corner-controls button:hover {
            background: #111827;
            color: #e5e7eb;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="countdown">--L+--H</div>
    <div class="controls">
        <button id="lock-lunch-btn" type="button">Lock lunch now</button>
    </div>
</div>

<!-- Bottom-left small controls -->
<div class="corner-controls">
    <button id="reset-lunch-btn" type="button">Reset lunch lock</button>
    <button id="set-lunch-manual-btn" type="button">Set lunch minutesâ€¦</button>
</div>

<script>
    const NOON_MINUTES = 12 * 60; // 12:00
    const FIVE_PM_MINUTES = 17 * 60; // 17:00
    const LUNCH_LOCK_KEY = "lunchLock"; // key in localStorage

    // Format integer with explicit sign for positive numbers
    function formatWithSign(minutes) {
        if (minutes > 0) return "+" + minutes;
        return minutes.toString(); // 0 or negative
    }

    // Get current time in America/Los_Angeles as components
    function getPacificComponents() {
        const now = new Date();

        const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: "America/Los_Angeles",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
        });

        const parts = formatter.formatToParts(now);
        const get = type => parts.find(p => p.type === type).value;

        return {
            year: Number(get("year")),
            month: Number(get("month")),
            day: Number(get("day")),
            hour: Number(get("hour")),
            minute: Number(get("minute"))
        };
    }

    // Build a YYYY-MM-DD string for Pacific date
    function getPacificDateKey(pac) {
        const m = pac.month.toString().padStart(2, "0");
        const d = pac.day.toString().padStart(2, "0");
        return pac.year + "-" + m + "-" + d;
    }

    // Read lunch lock (if any) from localStorage
    function getLunchLock() {
        try {
            const raw = localStorage.getItem(LUNCH_LOCK_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            return null;
        }
    }

    // Save lunch lock for today
    function setLunchLock(dateKey, minutes) {
        const payload = { date: dateKey, minutes: minutes };
        localStorage.setItem(LUNCH_LOCK_KEY, JSON.stringify(payload));
    }

    // Clear stored lunch lock
    function clearLunchLock() {
        localStorage.removeItem(LUNCH_LOCK_KEY);
    }

    function updateCountdown() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);

        const nowMinutes = pac.hour * 60 + pac.minute;

        // LUNCH (L) SIDE
        const stored = getLunchLock();
        let diffToNoon;

        if (stored && stored.date === todayKey) {
            // Frozen value for today
            diffToNoon = stored.minutes;
        } else {
            // No stored value or from previous day
            if (stored && stored.date !== todayKey) {
                clearLunchLock();
            }
            diffToNoon = NOON_MINUTES - nowMinutes;
        }

        // HOME (H) SIDE
        const diffToFive = FIVE_PM_MINUTES - nowMinutes;

        const noonPart = formatWithSign(diffToNoon) + "L";
        const fivePart = formatWithSign(diffToFive) + "H";

        document.getElementById("countdown").textContent = noonPart + fivePart;
    }

    function lockLunchNow() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);
        const nowMinutes = pac.hour * 60 + pac.minute;
        const diffToNoon = NOON_MINUTES - nowMinutes;

        setLunchLock(todayKey, diffToNoon);
        updateCountdown();
    }

    function resetLunchForToday() {
        // Just clear the lock; on next update it will go back to live count
        clearLunchLock();
        updateCountdown();
    }

    function setLunchManual() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);

        const input = prompt("Enter lunch offset in minutes (positive or negative):", "0");
        if (input === null) {
            // User cancelled
            return;
        }

        const minutes = Number(input);
        if (!Number.isFinite(minutes) || !Number.isInteger(minutes)) {
            alert("Please enter a whole number of minutes (e.g. -7, 0, 15).");
            return;
        }

        setLunchLock(todayKey, minutes);
        updateCountdown();
    }

    // Wire up buttons
    document.getElementById("lock-lunch-btn").addEventListener("click", lockLunchNow);
    document.getElementById("reset-lunch-btn").addEventListener("click", resetLunchForToday);
    document.getElementById("set-lunch-manual-btn").addEventListener("click", setLunchManual);

    // Initial draw
    updateCountdown();

    // Update every minute (H side keeps ticking, L side only if not locked)
    setInterval(updateCountdown, 60 * 1000);
</script>
</body>
</html>
