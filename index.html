<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session Utility Clock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="clock.png" type="image/png">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .wrapper {
            text-align: center;
        }

        #countdown {
            font-size: 3rem;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .note {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }

        /* Bottom-left corner controls */
        .corner-controls {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .corner-controls button {
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background: #020617;
            color: #9ca3af;
            cursor: pointer;
        }

        .corner-controls button:hover {
            background: #111827;
            color: #e5e7eb;
        }

        .settings-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-button:hover {
            background: #111827;
        }

        .settings-panel {
            position: fixed;
            top: 3.5rem;
            right: 1rem;
            background: #020617;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.75rem 0.9rem;
            font-size: 0.85rem;
            color: #e5e7eb;
            min-width: 180px;
            z-index: 50;
        }

        .settings-panel.hidden {
            display: none;
        }

        .settings-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .settings-row label {
            flex: 1;
        }

        .settings-row input[type="time"] {
            flex: 1;
            background: #020617;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            color: #e5e7eb;
            padding: 0.15rem 0.3rem;
            font-size: 0.8rem;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .settings-actions button {
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background: #111827;
            color: #e5e7eb;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .settings-actions button:hover {
            background: #1f2937;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="countdown">--L+--H</div>
</div>

<!-- Bottom-left small controls -->
<div class="corner-controls">
    <button id="lock-lunch-btn" type="button">Freeze Checkpoint</button>
    <button id="reset-lunch-btn" type="button">Reset Checkpoint</button>
    <button id="set-lunch-manual-btn" type="button">Manually Set Checkpoint</button>
</div>

<!-- Top-right settings gear -->
<button id="settings-btn" class="settings-button" type="button" aria-label="Settings">âš™</button>

<!-- Settings panel -->
<div id="settings-panel" class="settings-panel hidden">
    <div class="settings-header">Utility Settings</div>
    <div class="settings-row">
        <label for="lunch-time">L</label>
        <input id="lunch-time" type="time">
    </div>
    <div class="settings-row">
        <label for="home-time">H</label>
        <input id="home-time" type="time">
    </div>
    <div class="settings-actions">
        <button id="settings-save" type="button">Save</button>
        <button id="settings-cancel" type="button">Cancel</button>
    </div>
</div>

<script>
    const DEFAULT_LUNCH_MINUTES = 12 * 60;   // 12:00
    const DEFAULT_HOME_MINUTES  = 17 * 60;   // 17:00 (5 pm)
    const LUNCH_LOCK_KEY        = "lunchLock";   // key in localStorage
    const SETTINGS_KEY          = "lhSettings";


    // Format integer with explicit sign for positive numbers
    function formatWithSign(minutes) {
        if (minutes > 0) return "+" + minutes;
        return minutes.toString(); // 0 or negative
    }

    // Get current time in America/Los_Angeles as components
    function getPacificComponents() {
        const now = new Date();

        const formatter = new Intl.DateTimeFormat("en-US", {
            timeZone: "America/Los_Angeles",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
        });

        const parts = formatter.formatToParts(now);
        const get = type => parts.find(p => p.type === type).value;

        return {
            year: Number(get("year")),
            month: Number(get("month")),
            day: Number(get("day")),
            hour: Number(get("hour")),
            minute: Number(get("minute"))
        };
    }

    // Convert "HH:MM" into minutes since midnight
    function timeStringToMinutes(str) {
        if (!str) return null;
        const [hStr, mStr] = str.split(":");
        const h = Number(hStr);
        const m = Number(mStr);
        if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
        const total = h * 60 + m;
        if (total < 0 || total >= 24 * 60) return null;
        return total;
    }

    // Convert minutes since midnight into "HH:MM"
    function minutesToTimeString(minutes) {
        if (!Number.isFinite(minutes)) {
            return "12:00";
        }
        let m = minutes % (24 * 60);
        if (m < 0) m += 24 * 60;
        const h = Math.floor(m / 60);
        const min = m % 60;
        return h.toString().padStart(2, "0") + ":" + min.toString().padStart(2, "0");
    }

    // Get today's settings (L and H minutes), falling back to defaults
    function getSettingsForToday(pac) {
        const todayKey = getPacificDateKey(pac);

        try {
            const raw = localStorage.getItem(SETTINGS_KEY);
            if (!raw) {
                return {
                    date: todayKey,
                    lunchMinutes: DEFAULT_LUNCH_MINUTES,
                    homeMinutes: DEFAULT_HOME_MINUTES
                };
            }

            const parsed = JSON.parse(raw);
            if (!parsed || parsed.date !== todayKey) {
                // Old day or malformed, ignore
                return {
                    date: todayKey,
                    lunchMinutes: DEFAULT_LUNCH_MINUTES,
                    homeMinutes: DEFAULT_HOME_MINUTES
                };
            }

            return {
                date: parsed.date,
                lunchMinutes: Number.isFinite(parsed.lunchMinutes) ? parsed.lunchMinutes : DEFAULT_LUNCH_MINUTES,
                homeMinutes: Number.isFinite(parsed.homeMinutes) ? parsed.homeMinutes : DEFAULT_HOME_MINUTES
            };
        } catch (e) {
            return {
                date: todayKey,
                lunchMinutes: DEFAULT_LUNCH_MINUTES,
                homeMinutes: DEFAULT_HOME_MINUTES
            };
        }
    }

    function saveSettingsForToday(pac, lunchMinutes, homeMinutes) {
        const todayKey = getPacificDateKey(pac);
        const payload = {
            date: todayKey,
            lunchMinutes,
            homeMinutes
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(payload));
    }

    // Build a YYYY-MM-DD string for Pacific date
    function getPacificDateKey(pac) {
        const m = pac.month.toString().padStart(2, "0");
        const d = pac.day.toString().padStart(2, "0");
        return pac.year + "-" + m + "-" + d;
    }

    // Read lunch lock (if any) from localStorage
    function getLunchLock() {
        try {
            const raw = localStorage.getItem(LUNCH_LOCK_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            return null;
        }
    }

    // Save lunch lock for today
    function setLunchLock(dateKey, minutes) {
        const payload = { date: dateKey, minutes: minutes };
        localStorage.setItem(LUNCH_LOCK_KEY, JSON.stringify(payload));
    }

    // Clear stored lunch lock
    function clearLunchLock() {
        localStorage.removeItem(LUNCH_LOCK_KEY);
    }

    function updateCountdown() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);

        const nowMinutes = pac.hour * 60 + pac.minute;

        // Read today's L/H settings
        const settings = getSettingsForToday(pac);
        const lunchMinutes = settings.lunchMinutes;
        const homeMinutes  = settings.homeMinutes;

        // LUNCH (L) SIDE, still respecting any lock
        const stored = getLunchLock();
        let diffToLunch;

        if (stored && stored.date === todayKey) {
            // Frozen value for today
            diffToLunch = stored.minutes;
        } else {
            // No stored value or from previous day
            if (stored && stored.date !== todayKey) {
                clearLunchLock();
            }
            diffToLunch = lunchMinutes - nowMinutes;
        }

        // HOME (H) SIDE, always live
        const diffToHome = homeMinutes - nowMinutes;

        const noonPart = formatWithSign(diffToLunch) + "L";
        const fivePart = formatWithSign(diffToHome) + "H";

        document.getElementById("countdown").textContent = noonPart + fivePart;
    }

    function lockLunchNow() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);
        const nowMinutes = pac.hour * 60 + pac.minute;

        const settings = getSettingsForToday(pac);
        const lunchMinutes = settings.lunchMinutes;

        const diffToLunch = lunchMinutes - nowMinutes;

        setLunchLock(todayKey, diffToLunch);
        updateCountdown();
    }

    function resetLunchForToday() {
        // Just clear the lock; on next update it will go back to live count
        clearLunchLock();
        updateCountdown();
    }

    function setLunchManual() {
        const pac = getPacificComponents();
        const todayKey = getPacificDateKey(pac);

        const input = prompt("Enter Checkpoint offset (positive or negative):", "0");
        if (input === null) {
            // User cancelled
            return;
        }

        const minutes = Number(input);
        if (!Number.isFinite(minutes) || !Number.isInteger(minutes)) {
            alert("Please enter a whole number (e.g. -7, 0, 15).");
            return;
        }

        setLunchLock(todayKey, minutes);
        updateCountdown();
    }

    // Wire up buttons
    document.getElementById("lock-lunch-btn").addEventListener("click", lockLunchNow);
    document.getElementById("reset-lunch-btn").addEventListener("click", resetLunchForToday);
    document.getElementById("set-lunch-manual-btn").addEventListener("click", setLunchManual);

    const settingsBtn      = document.getElementById("settings-btn");
    const settingsPanel    = document.getElementById("settings-panel");
    const lunchTimeInput   = document.getElementById("lunch-time");
    const homeTimeInput    = document.getElementById("home-time");
    const settingsSaveBtn  = document.getElementById("settings-save");
    const settingsCancelBtn = document.getElementById("settings-cancel");

    function openSettingsPanel() {
        const pac = getPacificComponents();
        const settings = getSettingsForToday(pac);

        lunchTimeInput.value = minutesToTimeString(settings.lunchMinutes);
        homeTimeInput.value  = minutesToTimeString(settings.homeMinutes);

        settingsPanel.classList.remove("hidden");
    }

    function closeSettingsPanel() {
        settingsPanel.classList.add("hidden");
    }

    function saveSettingsFromPanel() {
        const lunchStr = lunchTimeInput.value;
        const homeStr  = homeTimeInput.value;

        const lunchMinutes = timeStringToMinutes(lunchStr);
        const homeMinutes  = timeStringToMinutes(homeStr);

        if (lunchMinutes === null || homeMinutes === null) {
            alert("Please enter valid times for both L and H.");
            return;
        }

        const pac = getPacificComponents();
        saveSettingsForToday(pac, lunchMinutes, homeMinutes);

        // When times change, it makes sense to clear any existing lunch lock
        clearLunchLock();

        closeSettingsPanel();
        updateCountdown();
    }

    settingsBtn.addEventListener("click", () => {
        if (settingsPanel.classList.contains("hidden")) {
            openSettingsPanel();
        } else {
            closeSettingsPanel();
        }
    });
    settingsSaveBtn.addEventListener("click", saveSettingsFromPanel);
    settingsCancelBtn.addEventListener("click", closeSettingsPanel);

    function tick() {
        // Update display
        updateCountdown();

        // Schedule next tick at the start of the next minute
        const now = new Date();
        const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
        const delay = msToNextMinute <= 0 ? 1000 : msToNextMinute; // safety

        setTimeout(tick, delay);
    }

    // Start aligned to the minute boundary
    tick();

</script>
</body>
</html>
